# List available commands
default:
    @just --list

# Install dependencies
[group('setup')]
bootstrap:
    uv sync

# Set up the application for the first time after cloning
[group('setup')]
setup: bootstrap
{%- if cookiecutter.database == "Tortoise" %}
    uv run python -m {{cookiecutter.project_slug}} migrate-db
{%- endif %}
    @echo "âœ“ Setup complete! Don't forget to:"
    @echo "  1. Copy .env.template to .env and configure it"
    @echo "  2. Create your database: createdb {{cookiecutter.project_slug}}"
{%- if cookiecutter.database == "Tortoise" %}
    @echo "  3. Run 'just migrate' to apply database migrations"
{%- endif %}

# Update dependencies to the latest versions
[group('setup')]
update:
    uv sync --upgrade

# Start the development server
[group('dev')]
server:
    uv run python -m {{cookiecutter.project_slug}} run-server

# Run all development services (server, worker, redis)
[group('dev')]
work:
    uv run python -m {{cookiecutter.project_slug}} work

# Run tests
[group('dev')]
test *ARGS:
    uv run pytest {{cookiecutter.project_slug}}/ {{ "{{ARGS}}" }}

# Open an interactive console
[group('dev')]
console:
{%- if cookiecutter.database == "Tortoise" %}
    uv run python -m {{cookiecutter.project_slug}} shell
{%- else %}
    uv run ipython
{%- endif %}

{%- if cookiecutter.database == "Tortoise" %}

# Apply database migrations
[group('database')]
migrate:
    uv run python -m {{cookiecutter.project_slug}} migrate-db

# Create a new database migration
[group('database')]
makemigrations NAME:
    uv run aerich migrate --name {{ "{{NAME}}" }}

# Initialize the database
[group('database')]
init-db:
    uv run aerich init-db
{%- endif %}

# Create a new user interactively
[group('utils')]
create-user:
    uv run python -m {{cookiecutter.project_slug}} create-user

# Generate a secure secret key
[group('utils')]
secret-key:
    uv run python -m {{cookiecutter.project_slug}} secret-key

# Show project health and settings information
[group('utils')]
info:
    uv run python -m {{cookiecutter.project_slug}} info

# Create a new FastAPI app/component
[group('utils')]
start-app NAME:
    uv run python -m {{cookiecutter.project_slug}} start-app {{ "{{NAME}}" }}

# Run the SAQ worker
[group('services')]
worker:
    uv run python -m {{cookiecutter.project_slug}} run-worker

# Run a test mail server for development
[group('services')]
mailserver:
    uv run python -m {{cookiecutter.project_slug}} run-mailserver

# Run the production server with gunicorn
[group('services')]
prod-server:
    uv run python -m {{cookiecutter.project_slug}} run-prod-server

# Run linting and formatting checks
[group('quality')]
lint:
    uv run pre-commit run --all-files

# Format code with black and isort
[group('quality')]
format:
    uv run black .
    uv run isort .

# Clean up temporary files and caches
[group('maintenance')]
clean:
    find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    find . -type f -name "*.pyc" -delete
    find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
